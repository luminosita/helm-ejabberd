name: CI | deploy and test
on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "main"
      - "bitnami"
env:
  KIND_VSN: "0.20.0"
jobs:
  deploy_test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        db: [pgsql, mariadb, mysql]
        schema: [new]
      fail-fast: false
    steps:
      - name: Check out code
        uses: actions/checkout@v1
      - name: Lint helm chart
        shell: bash
        working-directory: ./charts/ejabberd
        run: |
          helm lint .
      - name: Create KinD cluster
        shell: bash
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/v${{ env.KIND_VSN }}/kind-linux-amd64
          chmod +x /tmp/kind
          /tmp/kind create cluster --config=$GITHUB_WORKSPACE/.github/ci/kind-conf.yml
          kubectl get nodes -o wide
          echo "DB_APP=$(echo ${{ matrix.db }} | sed -e 's|pgsql|postgresql|;s|mariadb|mariadb|;s|mysql|mysql|')" >> $GITHUB_ENV
      - name: Create self signed certificate
        shell: bash
        run: |
          openssl req -x509 -newkey rsa:4096 -nodes -subj '/CN=example.com' -keyout server.pem -days 365
          kubectl create secret generic custom-cert --from-file=./server.pem
          kubectl label secret custom-cert "helm-ejabberd/watcher=true"
          kubectl annotate secret custom-cert "k8s-sidecar-target-directory=certs/custom-cert"
      - name: Deploy ${{ matrix.db }} database helm chart
        shell: bash
        run: |
          helm install ${{ matrix.db }} oci://registry-1.docker.io/bitnamicharts/${{ env.DB_APP }} \
            -f .github/ci/bitnami-${{ matrix.db }}-ci.yaml
          kubectl get all -o wide
          if [ ${{ matrix.db }} = 'pgsql' ]
          then sts_name="${{ matrix.db }}-${{ env.DB_APP }}"
          else sts_name="${{ matrix.db }}"
          fi
          kubectl rollout status sts $sts_name
          kubectl logs sts/$sts_name
      - name: Deploy ejabberd helm chart
        shell: bash
        working-directory: ./charts/ejabberd
        run: |
          helm install ejabberd --debug -f ../../.github/ci/ejabberd-${{ matrix.db }}-${{ matrix.schema }}-ci.yaml .
          kubectl rollout status sts ejabberd
      - name: Verify deployment
        shell: bash
        run: |
          kubectl get all -o wide
      - name: Check sidecar
        shell: bash
        run: |
          kubectl logs sts/ejabberd -c watcher
      - name: Check ejabberd statefulset
        shell: bash
        run: |
          kubectl logs sts/ejabberd -c ejabberd
          kubectl exec sts/ejabberd -c ejabberd -- ejabberdctl status
          kubectl exec sts/ejabberd -c ejabberd -- ejabberdctl register admin example.com password
          kubectl exec sts/ejabberd -c ejabberd -- ejabberdctl list_cluster
          kubectl logs sts/ejabberd -c ejabberd
      # - name: Call ejabberd API
      #   shell: bash
      #   run: |
      #     echo "127.0.0.1 example.com" | sudo tee -a /etc/hosts
      #     curl -L -d "{}" -X POST -k https://exmaple.com:30443/api/status
